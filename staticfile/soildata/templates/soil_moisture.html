{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soil Moisture Dashboard</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: { extend: { colors: { accent: "#3b82f6" } } },
      };
    </script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>

  <body
    class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex"
  >
    <!-- Sidebar -->
    {% include "sidebar.html" %}

    <!-- Main -->
    <div class="flex-1 space-y-6 p-6 ml-64">
      <div
        class="flex flex-col md:flex-row justify-between items-start md:items-center"
      >
        <h1 class="text-3xl font-bold text-blue-400 mb-4 md:mb-0">
          Soil Moisture
        </h1>
        <span
          id="latest-time"
          class="text-gray-500 dark:text-gray-400"
        >
          {% if readings %}
            Latest: {{ readings.0.updated_at|localtime|date:"h:i A d-m-Y" }}
          {% endif %}
        </span>
      </div>

      <!-- Latest Reading -->
      <div
        class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 hover:shadow-xl transition w-full md:w-1/3"
      >
        <div class="flex justify-between items-center">
          <span
            class="text-lg font-semibold text-gray-700 dark:text-gray-200"
          >Latest Reading</span>
          <i class="fa fa-tint text-blue-400 text-2xl"></i>
        </div>
        <p
          id="latest-moisture"
          class="mt-3 text-4xl font-bold text-gray-900 dark:text-white"
        >
          {{ readings.0.moisture }}%
        </p>
      </div>

      <!-- Trend Graph -->
      <div
        class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 hover:shadow-xl transition"
      >
        <h2
          class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4"
        >
          Soil Moisture Trend
        </h2>
        <canvas id="moistureChart" class="w-full h-64"></canvas>
      </div>

      <!-- Table -->
      <div
        class="bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 overflow-x-auto hover:shadow-xl transition"
      >
        <h2
          class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4"
        >
          Recent Readings
        </h2>
        <table
          class="w-full table-auto border-collapse text-gray-700 dark:text-gray-200"
        >
          <thead>
            <tr class="bg-gray-100 dark:bg-gray-700">
              <th class="px-4 py-2 text-left">Time</th>
              <th class="px-4 py-2 text-left">Moisture (%)</th>
            </tr>
          </thead>
          <tbody id="moistureTable">
            {% for r in readings %}
            <tr
              class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition"
            >
              <td class="px-4 py-2">
                {{ r.updated_at|localtime|date:"h:i A d-m-Y" }}
              </td>
              <td class="px-4 py-2">{{ r.moisture }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const ctx = document.getElementById("moistureChart").getContext("2d");
      let chart;

      // Create chart function
      function renderChart(data) {
        const labels = data.map((r) => r.time);
        const values = data.map((r) => r.moisture);

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Soil Moisture (%)",
                data: values,
                backgroundColor: "rgba(59,130,246,0.3)",
                borderColor: "rgba(59,130,246,1)",
                borderWidth: 2,
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: { responsive: true },
        });
      }

      // Fetch data from backend
      async function fetchMoistureData() {
        try {
          const response = await fetch("{% url 'soildata:api_moisture' %}");
          const data = await response.json();

          // Update latest reading
          document.getElementById("latest-moisture").textContent =
            data.latest.moisture + "%";
          document.getElementById("latest-time").textContent =
            "Latest: " + data.latest.time;

          // Update table
          const tbody = document.getElementById("moistureTable");
          tbody.innerHTML = "";
          data.readings.forEach((r) => {
            tbody.insertAdjacentHTML(
              "beforeend",
              `<tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                <td class="px-4 py-2">${r.time}</td>
                <td class="px-4 py-2">${r.moisture}</td>
              </tr>`
            );
          });

          // Update chart
          renderChart(data.readings.reverse());
        } catch (error) {
          console.error("Error loading data:", error);
        }
      }

      // Initial load + auto refresh every 10s
      fetchMoistureData();
      setInterval(fetchMoistureData, 10000);
    </script>
  </body>
</html>
