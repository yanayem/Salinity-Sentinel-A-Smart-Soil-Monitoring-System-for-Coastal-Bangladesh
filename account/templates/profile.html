{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile | Soil Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" />
  <style>
    body {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-gray-200 min-h-screen">

  {% include 'sidebar.html' %}

  <main class="ml-60 p-8">
    <div class="flex flex-wrap -mx-4 gap-y-8 justify-center">

      <!-- PROFILE CARD -->
      <div class="w-full lg:w-1/2 px-4">
        <div class="bg-gray-800/50 backdrop-blur-md rounded-2xl p-6 shadow-lg hover:shadow-2xl transition duration-300 max-w-[600px] mx-auto flex flex-col items-center">
          
          <form id="profileForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="relative group w-32 h-32 mt-4">
              <img id="profilePic"
                   {% if profile.profile_pic %}
                     src="{{ profile.profile_pic.url }}"
                   {% else %}
                     src="https://www.w3schools.com/howto/img_avatar.png"
                   {% endif %}
                   alt="User Avatar"
                   class="w-32 h-32 rounded-full border-4 border-green-500 object-cover hover:scale-105 transition"/>
              
              <div class="absolute inset-0 bg-black bg-opacity-40 rounded-full flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <!-- Upload -->
                <label for="uploadPic" class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 flex items-center justify-center rounded-full cursor-pointer">
                  <i class="fas fa-upload"></i>
                </label>
                <input type="file" id="uploadPic" name="profile_pic" class="hidden" accept="image/*" form="profileForm">
                <!-- Remove -->
                <button id="removePic" type="button" class="bg-red-600 hover:bg-red-500 text-white w-10 h-10 flex items-center justify-center rounded-full">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>
          </form>

          <h2 class="mt-4 text-2xl font-semibold text-white">{{ user.first_name }} {{ user.last_name }}</h2>
          <p class="text-gray-400 mt-1"><i class="fas fa-leaf"></i> Soil Monitoring Expert</p>
          
        </div>
      </div>

      <!-- ACCOUNT INFO CARD -->
      <div class="w-full h-36 lg:w-1/2 px-4">
        <div class="bg-gray-800/50 backdrop-blur-md rounded-2xl p-6 shadow-lg hover:shadow-2xl transition duration-300 max-w-[600px] mx-auto flex flex-col">

          <h3 class="text-green-500 text-xl font-semibold flex items-center gap-2"><i class="fas fa-user-circle"></i> Account Info</h3>
          <div class="mt-4 space-y-3">
            <div class="flex justify-between items-center border-b border-gray-600 pb-1">
              <span>Full Name</span>
              <span>{{ user.first_name }} {{ user.last_name }}</span>
            </div>
            <div class="flex justify-between items-center border-b border-gray-600 pb-1">
              <span>Email</span>
              <span>{{ user.email }}</span>
            </div>
            <div class="flex justify-between items-center border-b border-gray-600 pb-1">
              <span>Phone</span>
              <span>{{ profile.phone_number|default:"-" }}</span>
            </div>
            <div class="flex justify-between items-center border-b border-gray-600 pb-1">
              <span>Location</span>
              <span>{{ profile.location|default:"-" }}</span>
            </div>
            <div class="flex justify-between items-center border-b border-gray-600 pb-1">
              <span>Joined</span>
              <span>{{ user.date_joined|date:"M d, Y" }}</span>
            </div>
            <div>
              <a href="{% url 'account:settingpage' %}" class="mt-3 text-sm text-blue-400 hover:underline flex items-center gap-1">
                <i class="fas fa-edit"></i> Edit Profile Info
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- RECENT ACTIVITY CARD (last 3 moisture readings with timestamp) -->
<div class="w-full lg:w-1/2 px-4">
  <div class="bg-gray-800/50 backdrop-blur-md rounded-2xl p-6 shadow-lg hover:shadow-2xl transition duration-300 max-w-[600px] mx-auto flex flex-col">
    <h3 class="text-green-500 text-xl font-semibold flex items-center gap-2"><i class="fas fa-history"></i> Recent Moisture Readings</h3>
    <ul class="mt-4 space-y-2 text-gray-300">
      {% for reading in readings|slice:":3" %}
        <li class="flex justify-between items-center">
          <div>
            <i class="fas fa-tint text-green-500"></i> 
            Field {{ reading.device.name|default:"-" }}: {{ reading.moisture }}%
          </div>
          <div class="text-xs text-gray-400">
            {{ reading.updated_at|date:"M d, Y H:i" }}
          </div>
        </li>
      {% empty %}
        <li>No recent moisture readings</li>
      {% endfor %}
    </ul>
  </div>
</div>


    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const uploadPic = document.getElementById("uploadPic");
    const profilePic = document.getElementById("profilePic");
    uploadPic.addEventListener("change", e => {
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = () => profilePic.src = reader.result;
        reader.readAsDataURL(file);
        document.getElementById("profileForm").submit();
      }
    });

    const removePic = document.getElementById("removePic");
    removePic.addEventListener("click", () => {
      profilePic.src = "https://www.w3schools.com/howto/img_avatar.png";
      $.ajax({
        url: "{% url 'account:remove_profile_pic' %}",
        method: "POST",
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        data: JSON.stringify({remove: true}),
        contentType: "application/json",
        success: () => console.log("Profile picture removed")
      });
    });
  </script>

</body>
</html>
