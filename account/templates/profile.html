{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile | Soil Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="transition-colors duration-500 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 min-h-screen">

  {% include 'sidebar.html' %}

  <main class="md:ml-60 mt-16 p-8 space-y-8">

    <!-- PROFILE + ACCOUNT INFO -->
    <div class="flex flex-col lg:flex-row gap-4">

      <!-- PROFILE CARD -->
      <div class="w-full lg:w-1/2 h-full px-4">
        <div class="bg-gray-100/50 dark:bg-gray-800/30 backdrop-blur-md rounded-2xl p-6 shadow-lg hover:shadow-2xl transition duration-300 flex flex-col items-center h-full">
          
          <form id="profileForm" method="POST" enctype="multipart/form-data" class="w-full flex flex-col items-center">
            {% csrf_token %}

            <div class="relative group w-32 h-32 mt-4">
              <img id="profilePic"
                   {% if profile.profile_pic %}
                     src="{{ profile.profile_pic.url }}"
                   {% else %}
                     src="https://www.w3schools.com/howto/img_avatar.png"
                   {% endif %}
                   class="w-32 h-32 rounded-full border-4 border-green-500 object-cover"/>

              <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition">
                <label for="uploadPic"
                  class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 flex items-center justify-center rounded-full cursor-pointer">
                  <i class="fas fa-upload"></i>
                </label>

                <input type="file" id="uploadPic" name="profile_pic" class="hidden" accept="image/*">

                <button id="removePic" type="button"
                  class="bg-red-600 hover:bg-red-500 text-white w-10 h-10 flex items-center justify-center rounded-full">
                  <i class="fas fa-trash"></i>
                </button>
              </div>

            </div>

            <h2 class="mt-4 text-2xl font-semibold">{{ user.first_name }} {{ user.last_name }}</h2>
            <p class="text-gray-600 dark:text-gray-300 mt-1"><i class="fas fa-leaf"></i> Soil Monitoring Expert</p>
          </form>
        </div>
      </div>

      <!-- ACCOUNT INFO -->
      <div class="w-full lg:w-1/2 h-full px-4">
        <div class="bg-gray-100/50 dark:bg-gray-800/30 backdrop-blur-md rounded-2xl p-6 shadow-lg hover:shadow-2xl transition duration-300 h-full flex flex-col">
          <h3 class="text-green-500 text-xl font-semibold flex items-center gap-2"><i class="fas fa-user-circle"></i> Account Info</h3>

          <div class="mt-4 space-y-3 flex-1">
            <div class="border-b border-gray-400 dark:border-gray-600 pb-1 flex justify-between">
              <span>Full Name</span>
              <span>{{ user.first_name }} {{ user.last_name }}</span>
            </div>
            <div class="border-b border-gray-400 dark:border-gray-600 pb-1 flex justify-between">
              <span>Email</span>
              <span>{{ user.email }}</span>
            </div>
            <div class="border-b border-gray-400 dark:border-gray-600 pb-1 flex justify-between">
              <span>Phone</span>
              <span>{{ profile.phone_number|default:"-" }}</span>
            </div>
            <div class="border-b border-gray-400 dark:border-gray-600 pb-1 flex justify-between">
              <span>Location</span>
              <span>{{ profile.location|default:"-" }}</span>
            </div>
            <div class="border-b border-gray-400 dark:border-gray-600 pb-1 flex justify-between">
              <span>Joined</span>
              <span>{{ user.date_joined|date:"M d, Y" }}</span>
            </div>

            <div class="mt-3">
              <a href="{% url 'account:settingpage' %}" class="text-blue-600 dark:text-blue-400 hover:underline">
                <i class="fas fa-edit"></i> Edit Profile Info
              </a>
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- RECENT ACTIVITY -->
    <div class="w-full px-4">
      <div class="bg-gray-100/50 dark:bg-gray-800/30 backdrop-blur-md rounded-2xl p-6 shadow-lg hover:shadow-2xl transition duration-300">
        <h3 class="text-green-500 text-xl font-semibold flex items-center gap-2">
          <i class="fas fa-history"></i> Recent Moisture Readings
        </h3>

        <ul class="mt-4 space-y-2 text-gray-700 dark:text-gray-300">
          {% for reading in readings|slice:":3" %}
            <li class="flex justify-between items-center">
              <div><i class="fas fa-tint text-green-500"></i> Field {{ reading.device.name }}: {{ reading.moisture }}%</div>
              <span class="text-xs text-gray-500">{{ reading.updated_at|date:"M d, Y H:i" }}</span>
            </li>
          {% empty %}
            <li>No recent moisture readings</li>
          {% endfor %}
        </ul>
      </div>
    </div>

  </main>

  <!-- ========= SCRIPTS ========== -->
  <script>
    // ---------------------------
    // CSRF TOKEN (IMPORTANT)
    // ---------------------------
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
              cookie = cookie.trim();
              if (cookie.startsWith(name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              }
          }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    // ---------------------------
    // AJAX UPLOAD PROFILE PICTURE
    // ---------------------------
    document.getElementById("uploadPic").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        // Preview immediately
        const reader = new FileReader();
        reader.onload = () => {
          document.getElementById("profilePic").src = reader.result;
        };
        reader.readAsDataURL(file);

        // AJAX upload
        const formData = new FormData();
        formData.append("profile_pic", file);
        formData.append("csrfmiddlewaretoken", csrftoken);

        $.ajax({
            url: "{% url 'account:ajax_upload_profile_pic' %}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(res) {
                if(res.status === "success") {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: res.message,
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                    document.getElementById("profilePic").src = res.profile_pic_url;
                } else {
                    Swal.fire("Error", res.message, "error");
                }
            },
            error: function() {
                Swal.fire("Error", "Upload failed. Try again.", "error");
            }
        });
    });

    // ---------------------------
    // REMOVE PROFILE PICTURE
    // ---------------------------
    document.getElementById("removePic").addEventListener("click", function () {
        Swal.fire({
          title: "Remove your profile picture?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, remove it"
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: "{% url 'account:remove_profile_pic' %}",
              type: "POST",
              headers: { "X-CSRFToken": csrftoken },
              data: JSON.stringify({ remove: true }),
              contentType: "application/json",
              success: function () {
                document.getElementById("profilePic").src = "https://www.w3schools.com/howto/img_avatar.png";
                Swal.fire("Removed!", "Your profile photo has been removed.", "success");
              }
            });
          }
        });
    });
  </script>

</body>
</html>
