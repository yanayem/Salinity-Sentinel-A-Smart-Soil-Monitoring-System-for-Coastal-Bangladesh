{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŒ¿ Live Device Data</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

{% include 'sidebar.html' %}

<main class="ml-64 p-8 max-w-7xl mx-auto">
  <header class="text-center mb-10">
    <h1 class="text-3xl font-bold text-green-600">ðŸŒ¿ Live Device Data</h1>
    <p class="text-gray-600">Real-time readings for active devices</p>
  </header>

  {% for device in devices %}
  <div class="bg-white shadow rounded-lg mb-8 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold">{{ device.name }}</h2>
      <p class="text-sm text-gray-600">Device ID: {{ device.device_id }} | Location: {{ device.location|default:"-" }}</p>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full bg-white">
        <thead class="bg-green-600 text-white">
          <tr>
            <th class="py-3 px-4 text-left">pH Level</th>
            <th class="py-3 px-4 text-left">Humidity (%)</th>
            <th class="py-3 px-4 text-left">Temperature (Â°C)</th>
            <th class="py-3 px-4 text-left">Time</th>
          </tr>
        </thead>
        <tbody id="live-{{ device.id }}" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>
  {% endfor %}
</main>

<script>
{% for device in devices %}
const tbody_{{ device.id }} = document.getElementById('live-{{ device.id }}');

// Demo readings if database has no readings
let demoReadings = [
    {ph:6.8, humidity:62, temperature:25},
    {ph:6.5, humidity:64, temperature:26},
    {ph:7.2, humidity:60, temperature:25},
    {ph:7.8, humidity:63, temperature:26},
];

// Get latest 5 readings from database
let readings_{{ device.id }} = [
    {% if device.readings.exists %}
        {% for r in device.readings.all|dictsortreversed:"timestamp"|slice:":5" %}
            {ph: {{ r.ph_level|default:6.5 }}, humidity: {{ r.humidity|default:60 }}, temperature: {{ r.temperature|default:25 }}, timestamp: "{{ r.timestamp|date:'H:i d-m-Y' }}"},
        {% endfor %}
    {% else %}
        ...demoReadings
    {% endif %}
];

// Function to add row
function addRow_{{ device.id }}(reading){
    const tr = document.createElement('tr');
    tr.className = "bg-white";
    tr.innerHTML = `
        <td class="py-2 px-4">${reading.ph.toFixed(2)}</td>
        <td class="py-2 px-4">${reading.humidity}%</td>
        <td class="py-2 px-4">${reading.temperature.toFixed(1)}Â°C</td>
        <td class="py-2 px-4">${reading.timestamp || new Date().toLocaleTimeString() + " " + new Date().toLocaleDateString()}</td>
    `;
    tbody_{{ device.id }}.prepend(tr);
    if(tbody_{{ device.id }}.rows.length > 10) tbody_{{ device.id }}.deleteRow(-1);
}

// Insert initial readings
readings_{{ device.id }}.forEach(r => addRow_{{ device.id }}(r));

// Simulate live updates (demo or real device)
setInterval(()=>{
    const last = readings_{{ device.id }}[readings_{{ device.id }}.length-1] || {ph:6.8, humidity:62, temperature:25};
    const newReading = {
        ph: parseFloat((last.ph + (Math.random()*0.2-0.1)).toFixed(2)),
        humidity: parseFloat((last.humidity + (Math.random()*2-1)).toFixed(0)),
        temperature: parseFloat((last.temperature + (Math.random()*1-0.5)).toFixed(1)),
        timestamp: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}) + " " + new Date().toLocaleDateString()
    };
    readings_{{ device.id }}.push(newReading);
    if(readings_{{ device.id }}.length > 10) readings_{{ device.id }}.shift();
    addRow_{{ device.id }}(newReading);
}, 5000);
{% endfor %}
</script>

</body>
</html>
