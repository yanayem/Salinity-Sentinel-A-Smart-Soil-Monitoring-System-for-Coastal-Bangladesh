<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Signup</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/log_sign.css' %}" />
</head>
<body>
  {% include "nav.html" %}

  <section class="auth-container">
    <!-- Display Django messages -->
    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <p class="{{ message.tags }}">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <div class="card-3d-wrapper" id="card-wrapper">

      <!-- LOGIN CARD -->
      <div class="card front" id="loginCard">
        <h1>Log In</h1>
        <form method="post" action="{% url 'login_signup' %}">
          {% csrf_token %}
          <input type="email" name="username" placeholder="Email" required />
          <input type="password" name="password" placeholder="Password" required />
          <label class="checkbox">
            <input type="checkbox" /> Remember me
          </label>
          <button type="submit" name="login_submit" class="btn">Login</button>
          <p>Don't have an account? <a href="#" id="toSignup">Sign Up</a></p>
        </form>
      </div>

      <!-- SIGNUP CARD -->
      <div class="card back" id="signupCard">
        <h1>Sign Up</h1>
        <form method="post" action="{% url 'login_signup' %}?mode=signup">
          {% csrf_token %}
          
          <input type="text" name="full_name" placeholder="Full Name" required />
          <input type="tel" name="phone_number" placeholder="Phone Number" required />
          <input type="email" name="email" placeholder="Email" required />
          <input type="password" name="password1" placeholder="Password" required />
          <input type="password" name="password2" placeholder="Confirm Password" required />
          <input type="text" name="location" placeholder="Location" required />

          <!-- Hidden username populated from email -->
          <input type="hidden" name="username" id="username_hidden" />

          <button type="submit" name="signup_submit" class="btn">Sign Up</button>
          <p>Already have an account? <a href="#" id="toLogin">Log In</a></p>
        </form>
      </div>

    </div>
  </section>

  <script>
    const card = document.getElementById("card-wrapper");

    // Determine mode from Django variable or URL
    const djangoMode = "{{ mode|default:'' }}";
    const params = new URLSearchParams(window.location.search);
    const urlMode = params.get('mode');
    const mode = djangoMode || urlMode || 'login';

    // Set initial state
    if (mode === 'signup') {
      card.classList.add("flipped");
    } else {
      card.classList.remove("flipped");
    }

    // Flip buttons
    const toSignup = document.getElementById("toSignup");
    const toLogin = document.getElementById("toLogin");
    if (toSignup && toLogin) {
      toSignup.addEventListener("click", e => {
        e.preventDefault();
        card.classList.add("flipped");
      });
      toLogin.addEventListener("click", e => {
        e.preventDefault();
        card.classList.remove("flipped");
      });
    }

    // Auto-populate hidden username from email
    const emailInput = document.querySelector('input[name="email"]');
    const usernameInput = document.getElementById('username_hidden');
    if (emailInput && usernameInput) {
      emailInput.addEventListener('input', () => {
        usernameInput.value = emailInput.value;
      });
    }
  </script>
</body>
</html>
