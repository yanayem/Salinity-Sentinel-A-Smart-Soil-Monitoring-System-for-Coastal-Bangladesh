{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soil AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Fade + slide animation for messages */
      @keyframes fadeSlide {
        0% {
          opacity: 0;
          transform: translateY(10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-slide {
        animation: fadeSlide 0.4s ease forwards;
      }

      /* Typing indicator dots */
      .typing-indicator {
        display: flex;
        gap: 4px;
        align-items: center;
        margin-bottom: 8px;
      }
      .dot {
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        animation: bounce 1s infinite;
      }
      .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body class="bg-blue-950 text-white flex h-screen">
    <!-- Left Sidebar -->
    <div class="w-64 bg-blue-900 p-4 flex-shrink-0">
      {% include 'sidebar.html' %}
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col relative">
      <!-- Header -->
      <div
        class="fixed top-0 left-64 right-72 bg-blue-800 z-10 p-4 flex justify-between items-center shadow"
      >
        <h1 class="font-bold text-xl">Soil Expert Chat</h1>
        <button
          id="new-chat"
          class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded"
        >
          New Chat
        </button>
      </div>

      <!-- Chat Box -->
      <div
        id="chat-box"
        class="flex-1 p-4 mt-16 mb-20 overflow-y-auto"
        style="background-color: #0e1f3a"
      >
        {% for message in messages %}
        <div
          id="msg-{{ message.id }}"
          class="flex {% if message.sender == 'user' %}justify-end{% else %}justify-start{% endif %} mb-2 fade-slide"
        >
          <div
            class="px-4 py-2 rounded-lg max-w-xs {% if message.sender == 'user' %}bg-blue-700{% else %}bg-blue-600 text-white{% endif %} break-words"
          >
            {{ message.text }}
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Input Bar -->
      <form
        id="chat-form"
        class="fixed bottom-0 left-64 right-72 flex p-2 bg-blue-800 border-t border-blue-700 z-10"
      >
        {% csrf_token %}
        <input
          id="chat-input"
          type="text"
          name="message"
          placeholder="Type your question..."
          class="flex-1 p-3 bg-blue-900 text-white focus:outline-none rounded-l"
        />
        <button
          type="submit"
          class="px-4 bg-blue-600 hover:bg-blue-700 rounded-r"
        >
          Send
        </button>
      </form>
    </div>

    <!-- Right History Panel -->
    <div
      class="w-72 bg-blue-900 p-4 overflow-y-auto flex-shrink-0"
      id="chat-history"
    >
      <h2 class="font-bold mb-4 text-lg">Chat History</h2>
      <ul class="space-y-2">
        {% for session_item in history %}
        <li
          class="p-2 rounded bg-blue-800 cursor-pointer hover:bg-blue-600 break-words"
          onclick="window.location='{% url 'chat' session_item.id %}'"
        >
          {{ session_item.title|truncatechars:50 }}
        </li>
        {% endfor %}
      </ul>
    </div>

    <script>
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatBox = document.getElementById("chat-box");
      const historyBox = document.getElementById("chat-history");
      let typingDiv = null;

      function scrollBottom() {
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
      }

      function showTyping() {
        if (!typingDiv) {
          typingDiv = document.createElement("div");
          typingDiv.className = "typing-indicator";
          typingDiv.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
          chatBox.appendChild(typingDiv);
          scrollBottom();
        }
      }

      function hideTyping() {
        if (typingDiv) {
          typingDiv.remove();
          typingDiv = null;
        }
      }

      function appendMessage(msg) {
        const div = document.createElement("div");
        div.id = "msg-" + msg.id;
        div.className =
          "flex " +
          (msg.sender == "user" ? "justify-end" : "justify-start") +
          " mb-2 fade-slide";
        div.innerHTML = `<div class="px-4 py-2 rounded-lg max-w-xs ${
          msg.sender == "user" ? "bg-blue-700" : "bg-blue-600 text-white"
        } break-words">${msg.text}</div>`;
        chatBox.appendChild(div);
        scrollBottom();
      }

      function updateHistory(history) {
        const ul = historyBox.querySelector("ul");
        ul.innerHTML = "";
        history.forEach((session) => {
          const li = document.createElement("li");
          li.className =
            "p-2 rounded bg-blue-800 cursor-pointer hover:bg-blue-600 break-words";
          li.textContent =
            session.title.length > 50
              ? session.title.substring(0, 50) + "..."
              : session.title;
          li.onclick = () => {
            window.location = `/chat/${session.id}/`;
          };
          ul.appendChild(li);
        });
      }

      function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        const csrfToken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;

        // Append user message immediately
        const tempId = "temp-user-" + Date.now();
        const userDiv = document.createElement("div");
        userDiv.id = tempId;
        userDiv.className = "flex justify-end mb-2 fade-slide";
        userDiv.innerHTML = `<div class="px-4 py-2 rounded-lg max-w-xs bg-blue-700 break-words">${message}</div>`;
        chatBox.appendChild(userDiv);
        chatInput.value = "";
        scrollBottom();

        // Show bot typing
        showTyping();

        // Send to server
        fetch(window.location.href, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken,
          },
          body: `message=${encodeURIComponent(message)}`,
        })
          .then((res) => res.json())
          .then((data) => {
            hideTyping();
            data.messages.forEach((msg) => {
              if (
                msg.sender === "bot" &&
                !document.getElementById("msg-" + msg.id)
              ) {
                appendMessage(msg);
              }
            });
            updateHistory(data.history || []);
          })
          .catch((err) => {
            hideTyping();
            appendMessage({
              id: "error-" + Date.now(),
              sender: "bot",
              text: "Sorry, I couldn't generate a response right now.",
            });
            console.error(err);
          });
      }

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        sendMessage();
      });
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });
      document.getElementById("new-chat").addEventListener("click", () => {
        window.location.href = "{% url 'chat_new' %}?new=true";
      });

      scrollBottom();
    </script>
  </body>
</html>
